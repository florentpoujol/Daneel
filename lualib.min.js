// https://github.com/florentpoujol/lua.js/blob/fix_missing_string_functions/src/lualib.js
function slice(e,t){if(e.slice){return e.slice(t)}else{return Array.prototype.slice.call(e,t)}}function not_supported(){throw new Error("Not supported")}function ensure_arraymode(e){if(!e.arraymode){var t=[];for(var n in e.uints){if(e.uints[n]!=null){t[n-1]=e.uints[n]}}e.uints=t;e.arraymode=true}}function ensure_notarraymode(e){if(e.arraymode){var t={};for(var n in e.uints){if(e.uints[n]!=null){t[n- -1]=e.uints[n]}}e.uints=t;delete e.arraymode}}function check_string(e){var t=typeof e;if(t=="string"){return e}else if(t=="number"){return e.toString()}else{throw new Error("Input not string")}}function ReturnValues(e){this.vars=e||[]}function lua_true(e){return e!=null&&e!==false}function lua_not(e){return e==null||e===false}function lua_and(e,t){return e==null||e===false?e:t()}function lua_or(e,t){return e!=null&&e!==false?e:t()}function lua_assertfloat(e){var t=parseFloat(e);if(isNaN(t)){throw new Error("Invalid number: "+e)}return t}function lua_newtable(e){var t={str:{},uints:{},floats:{},bool:{},objs:[]};for(var n=1;n<arguments.length-1;n+=2){var r=arguments[n+1];if(r==null){continue}var i=arguments[n];switch(typeof i){case"string":t.str[i]=r;break;case"number":if(i!=i){throw new Error("Table index is NaN")}if(i>0&&(i|0)==i){t.uints[i]=r}else{t.floats[i]=r}break;case"boolean":t.bool[i]=r;break;case"object":if(i==null){throw new Error("Table index is nil")}var s=r==null;for(var n in t.objs){if(t.objs[n][0]===i){if(r==null){t.objs.splice(n,1)}else{s=true;t.objs[n][1]=r}break}}if(!s){t.objs.push([i,r])}break;default:throw new Error("Unsupported type for table: "+typeof i)}}if(e){ensure_arraymode(t);if(t.uints.length==0){t.uints=e}else{n=e.length;while(n-->0){t.uints[n]=e[n]}}}return t}function lua_newtable2(e){var t={};for(var n in e){t[n]=e[n]}return{str:t,uints:{},floats:{},bool:{},objs:{}}}function lua_len(e){if(typeof e=="string"){return e.length}else if(typeof e=="object"&&e!=null){if(e.length==null){var t=0;if(e.arraymode){while(e.uints[t++]!=null){}return e.length=t-1}else{while(e.uints[++t]!=null){}return e.length=t-1}}else{return e.length}}else{var n=e.metatable&&e.metatable.str["__len"];if(n){return lua_rawcall(n,[e])[0]}else{throw new Error("Length of <"+e+"> not supported")}}}function lua_rawcall(e,t){try{return e.apply(null,t)}catch(n){if(n.constructor==ReturnValues){return n.vars}throw n}}function lua_tablegetcall(e,t,n){var r=lua_tableget(e,t);if(typeof r=="function"){return lua_rawcall(r,n)}else{if(r==null){throw new Error("attempt to call field '"+t+"' (a nil value)")}var i=r.metatable&&r.metatable.str["__call"];if(i!=null){return lua_rawcall(i,[r].concat(n))}else{throw new Error("Could not call "+r+" as function")}}}function lua_call(e,t){if(typeof e=="function"){return lua_rawcall(e,t)}else{if(e==null){throw new Error("attempt to call function (a nil value)")}var n=e.metatable&&e.metatable.str["__call"];if(n!=null){return lua_rawcall(n,[e].concat(t))}else{throw new Error("Could not call "+e+" as function")}}}function lua_mcall(e,t,n){var r=lua_tableget(e,t);if(r==null){throw new Error("attempt to call method '"+t+"' (a nil value)")}return lua_call(r,[e].concat(n))}function lua_eq(e,t){if(typeof e!=typeof t){if(e==null&&t==null){return true}return false}if(e==t){return true}if(e==null||t==null){return false}var n=e.metatable&&e.metatable.str["__eq"];if(n&&n==(t.metatable&&t.metatable.str["__eq"])){return lua_true(lua_rawcall(n,[e,t])[0])}else{return false}}function lua_lt(e,t){if(typeof e=="number"&&typeof t=="number"){return e<t}else if(typeof e=="string"&&typeof t=="string"){return e<t}else{var n=e.metatable&&e.metatable.str["__lt"];if(n&&n==(t.metatable&&t.metatable.str["__lt"])){return lua_true(lua_rawcall(n,[e,t])[0])}else{throw new Error("Unable to compare "+e+" and "+t)}}}function lua_lte(e,t){if(typeof e=="number"&&typeof t=="number"){return e<=t}else if(typeof e=="string"&&typeof t=="string"){return e<=t}else{var n=e.metatable&&e.metatable.str["__le"];if(n&&n==(t.metatable&&t.metatable.str["__le"])){return lua_true(lua_rawcall(n,[e,t])[0])}else{var n=e.metatable&&e.metatable.str["__lt"];if(n&&n==(t.metatable&&t.metatable.str["__lt"])){return lua_not(lua_rawcall(n,[t,e])[0])}else{throw new Error("Unable to compare "+e+" and "+t)}}}}function lua_unm(e){var t=parseFloat(e);if(!isNaN(t)){return-t}else{var n=e.metatable&&e.metatable.str["__unm"];if(n){return lua_rawcall(n,[e])[0]}else{throw new Error("Inverting <"+e+"> not supported")}}}function lua_add(e,t){var n=parseFloat(e),r=parseFloat(t);if(isNaN(n)||isNaN(r)){var i=e.metatable&&e.metatable.str["__add"]||t.metatable&&t.metatable.str["__add"];if(i){return lua_rawcall(i,[e,t])[0]}else{throw new Error("Adding <"+e+"> and <"+t+"> not supported")}}else{return n+r}}function lua_subtract(e,t){var n=parseFloat(e),r=parseFloat(t);if(isNaN(n)||isNaN(r)){var i=e.metatable&&e.metatable.str["__sub"]||t.metatable&&t.metatable.str["__sub"];if(i){return lua_rawcall(i,[e,t])[0]}else{throw new Error("Subtracting <"+e+"> and <"+t+"> not supported")}}else{return n-r}}function lua_divide(e,t){var n=parseFloat(e),r=parseFloat(t);if(isNaN(n)||isNaN(r)){var i=e.metatable&&e.metatable.str["__div"]||t.metatable&&t.metatable.str["__div"];if(i){return lua_rawcall(i,[e,t])[0]}else{throw new Error("Dividing <"+e+"> and <"+t+"> not supported")}}else{return n/r}}function lua_multiply(e,t){var n=parseFloat(e),r=parseFloat(t);if(isNaN(n)||isNaN(r)){var i=e.metatable&&e.metatable.str["__mul"]||t.metatable&&t.metatable.str["__mul"];if(i){return lua_rawcall(i,[e,t])[0]}else{throw new Error("Multiplying <"+e+"> and <"+t+"> not supported")}}else{return n*r}}function lua_power(e,t){var n=parseFloat(e),r=parseFloat(t);if(isNaN(n)||isNaN(r)){var i=e.metatable&&e.metatable.str["__pow"]||t.metatable&&t.metatable.str["__pow"];if(i){return lua_rawcall(i,[e,t])[0]}else{throw new Error("<"+e+"> to the power of <"+t+"> not supported")}}else{return Math.pow(n,r)}}function lua_mod(e,t){var n=parseFloat(e),r=parseFloat(t);if(isNaN(n)||isNaN(r)){var i=e.metatable&&e.metatable.str["__mod"]||t.metatable&&t.metatable.str["__mod"];if(i){return lua_rawcall(i,[e,t])[0]}else{throw new Error("Modulo <"+e+"> and <"+t+"> not supported")}}else{if(n>=0){if(r>=0){return n%r}else{return(r+n%r)%r}}else{if(r>=0){return(r+n%r)%r}else{return n%r}}}}function lua_rawget(e,t){switch(typeof t){case"string":return e.str[t];case"number":if(t!=t){throw new Error("Table index is NaN")}if(t>0&&(t|0)==t){if(e.arraymode){return e.uints[t-1]}else{return e.uints[t]}}else{return e.floats[t]};case"boolean":return e.bool[t];case"object":if(t==null){return null}for(var n in e.objs){if(e.objs[n][0]==t){return e.objs[n][1]}}break;default:throw new Error("Unsupported key for table: "+typeof t)}}function lua_rawset(e,t,n){delete e.length;switch(typeof t){case"string":if(n==null){delete e.str[t]}else{e.str[t]=n}break;case"number":if(t!=t){throw new Error("Table index is NaN")}if(t>0&&(t|0)==t){ensure_notarraymode(e);if(n==null){delete e.uints[t]}else{e.uints[t]=n}}else{if(n==null){delete e.floats[t]}else{e.floats[t]=n}}break;case"boolean":if(n==null){delete e.bool[t]}else{e.bool[t]=n}break;case"object":if(t==null){throw new Error("Table index is nil")}var r=n==null;for(var i in e.objs){if(e.objs[i][0]==t){if(n==null){e.objs.splice(i,1)}else{r=true;e.objs[i][1]=n}break}}if(!r){e.objs.push([t,n])}break;default:throw new Error("Unsupported key for table: "+typeof t)}}function lua_tableget(e,t){if(e==null){throw new Error("attempt to index field '"+t+"' in a nil value")}if(typeof e=="object"){var n=lua_rawget(e,t);if(n!=null){return n}var r=e.metatable&&e.metatable.str["__index"];if(r==null){return null}}else{var r=e.metatable&&e.metatable.str["__index"];if(r==null){throw new Error("Unable to index key "+t+" from "+e)}}if(typeof r=="function"){return lua_rawcall(r,[e,t])[0]}else{return lua_tableget(r,t)}}function lua_tableset(e,t,n){if(e==null){throw new Error("attempt to set field '"+t+"' in a nil value")}if(typeof e=="object"){var r=lua_rawget(e,t);if(r!=null){lua_rawset(e,t,n);return}var i=e.metatable&&e.metatable.str["__newindex"];if(i==null){lua_rawset(e,t,n);return}}else{var i=e.metatable&&e.metatable.str["__newindex"];if(i==null){throw new Error("Unable to set key "+t+" in table "+e)}}if(typeof i=="function"){lua_rawcall(i,[e,t,n])}else{lua_tableset(i,t,n)}}function lua_concat(e,t){if(typeof e=="number"&&typeof t=="number"){throw new Error("number concat not supported yet")}else if((typeof e=="string"||typeof e=="number")&&(typeof t=="string"||typeof t=="number")){return e+t}else{var n=e.metatable&&e.metatable.str["__concat"]||t.metatable&&t.metatable.str["__concat"];if(n){return lua_rawcall(n,[e,t])[0]}else{throw new Error("Unable to concat "+e+" and "+t)}}}function lua_tonumber(e,t){var n=typeof e;if(n=="number"){return e}if(n!="string"||e.search("[^0-9. -]")!=-1){return null}var r;if(t===10||t==null){r=parseFloat(e)}else{r=parseInt(e,t)}if(isNaN(r)){r=null}return r}function _ipairs_next(e,t){var n;if(e.arraymode){n=e.uints[t]}else{n=e.uints[t+1]}if(n==null){return[null,null]}return[t+1,n]}function lua_createmodule(e,t,n){var r=lua_tableget(lua_packages,t)||lua_tableget(e,t)||lua_newtable();lua_tableset(e,t,r);lua_tableset(lua_packages,t,r);lua_tableset(r,"_NAME",t);lua_tableset(r,"_M",r);lua_tableset(r,"_PACKAGE",t.split(".").slice(0,-1).join("."));for(var i=0;i<n.length;i++){lua_call(n[i],[r])}return r}function lua_module(e){var t=lua_tableget(lua_packages,e);if(t==null){throw new Error("Module "+e+" not found. Module must be loaded before use.")}return t}function lua_require(e,t){var n=lua_module(t);var r=e;var i=t.split(".");for(var s=0;s<i.length-1;s++){if(!lua_tableget(r,i[s])){var o=lua_newtable();lua_tableset(r,i[s],o);r=o}}lua_tableset(r,i[i.length-1],n);return n}function lua_pattern_to_regex(e){var t=[/%[aAcCdDgGlLpPsSuUwW]-/g,/(]|\))-/g,/[^%]-(\)|%)/g,/%(g|G)/g,/(^[^%]+%b|%b.{2}.+$)/g,/%[0-9]{1}/g];for(var n in t){if(e.search(t[n])!=-1){not_supported()}}var r={"%f\\[([^\\]]+)\\]":"[^$1]{1}[$1]{1}","%a":"[a-zA-ZÀ-ſ]","%A":"[^a-zA-ZÀ-ſ]","%c":"[\0-]","%C":"[^\0-]","%d":"\\d","%D":"\\D","%l":"[a-zà-ÿ]","%L":"[^a-zà-ÿ]","%p":"[,?;.:/\\!()[]{}\"'#|%$`^@~&+*<>-]","%P":"[^,?;.:/\\!()[]{}\"'#|%$`^@~&+*<>-]","%s":"\\s","%S":"\\S","%u":"[A-ZÀ-ß]","%U":"[^A-ZÀ-ß]","%w":"\\w","%W":"\\W","%\\.":"\\.","%\\^":"\\^","%\\$":"\\$","%\\(":"\\(","%\\)":"\\)","%\\[":"\\[","%\\]":"\\]","%\\*":"\\*","%\\+":"\\+","%\\-":"\\-","%\\?":"\\?","%%":"%"};for(var i in r){e=e.replace(new RegExp(i,"g"),r[i])}return e}function get_balanced_match(e,t){var n=t.search(/%b.{1}.{1}/);if(n!==-1){var r=t[2];var i=t[3];var s=-1;var o=-1;var u=[];var a=-1;for(var f in e){f=parseInt(f);var l=e[f];if(l===r){u.push(f);if(s<0){o=f;s=0}s++}else if(l===i){s--;a=f;if(s===0){break}}}if(s>0){o=u[s]}if(o>=0&&a>=0){return e.substring(o,a+1)}}return null}var lua_libs={};var lua_core={assert:function(e,t){if(arguments.length<1){t="assertion failed!"}if(e!=null&&e!==false){return[e]}else{throw new Error(t)}},collectgarbage:function(){},dofile:function(){not_supported()},error:function(e,t){throw new Error(e)},getfenv:function(e,t){not_supported()},getmetatable:function(e){return[e.metatable&&(e.metatable.str["__metatable"]||e.metatable)]},ipairs:function(e){return[_ipairs_next,e,0]},load:function(e,t){var n="",r;while((r=e())!=null&&r!=""){n+=r}try{return[lua_load(n,t)]}catch(i){return[null,i.message]}},loadfile:function(){not_supported()},loadstring:function(e,t){try{return[lua_load(e,t)]}catch(n){return[null,n.message]}},next:function(){not_supported()},pairs:function(e){var t=[],n;for(n in e.str){t.push(n)}if(e.arraymode){var r=e.uints.length;while(r-->0){if(e.uints[r]!=null){t.push(r+1)}}}else{for(n in e.uints){t.push(parseFloat(n))}}for(n in e.floats){t.push(parseFloat(n))}for(n in e.bool){t.push(n==="true"?true:false)}for(n in e.objs){t.push(e.objs[n][0])}n=0;return[function(e,r){var s;do{if(n>=t.length){return[null,null]}r=t[n++];s=lua_rawget(e,r)}while(s==null);return[r,s]},e,null]},pcall:function(e){try{return[true].concat(e.apply(null,slice(arguments,1)))}catch(t){return[false,t.message]}},print:lua_print,rawequal:function(e,t){return[e==t||e==null&&t==null]},rawget:function(e,t){if(typeof e=="object"&&e!=null){return[lua_rawget(e,t)]}throw new Error("Unable to index key "+t+" from "+e)},rawset:function(e,t,n){if(typeof e=="object"&&e!=null&&t!=null){lua_rawset(e,t,n);return[e]}throw new Error("Unable set key "+t+" in "+e)},select:function(e){if(e==="#"){return[arguments.length-1]}else{e=lua_assertfloat(e);if(e>=1){return slice(arguments,lua_assertfloat(e))}else{throw new Error("Index out of range")}}},setfenv:function(e,t){not_supported()},setmetatable:function(e,t){if(typeof e!="object"||e==null){throw new Error("table expected, got "+e)}if(t==null){delete e.metatable}else if(typeof t==="object"){e.metatable=t}else{throw new Error("table or nil expected, got "+t)}return[e]},tonumber:function(e,t){return[lua_tonumber(e,t)]},tostring:function(e){if(e==null){return["nil"]}var t=e.metatable&&e.metatable.str["__tostring"];if(t){return lua_rawcall(t,[e])}else{switch(typeof e){case"number":case"boolean":return[e.toString()];case"string":return[e];case"object":return["table"];case"function":return["function"];default:return["nil"]}}},type:function(e){switch(typeof e){case"number":return["number"];case"string":return["string"];case"boolean":return["boolean"];case"function":return["function"];case"object":return[e===null?"nil":"table"];case"undefined":return["nil"];default:throw new Error("Unexpected value of type "+typeof e)}},unpack:function(e,t,n){ensure_arraymode(e);if(e.length!=null){n=e.length}else{n=0;while(e.uints[n++]!=null){}e.length=--n}if(t==null||t<1){t=1}if(n==null){n=e.length}throw new ReturnValues(e.uints.slice(t-1,n))},_VERSION:"Lua 5.1",xpcall:function(){not_supported()}};var _lua_coroutine=lua_libs["coroutine"]={};_lua_coroutine["resume"]=_lua_coroutine["running"]=_lua_coroutine["status"]=_lua_coroutine["wrap"]=_lua_coroutine["yield"]=_lua_coroutine["create"]=function(){not_supported()};var _lua_debug=lua_libs["debug"]={getmetatable:function(e){return[e.metatable]}};_lua_debug["traceback"]=_lua_debug["getfenv"]=_lua_debug["gethook"]=_lua_debug["getinfo"]=_lua_debug["getlocal"]=_lua_debug["getregistry"]=_lua_debug["getupvalue"]=_lua_debug["setfenv"]=_lua_debug["sethook"]=_lua_debug["setlocal"]=_lua_debug["setupvalue"]=_lua_debug["debug"]=function(){not_supported()};var _lua_write_buffer="";var _lua_io=lua_libs["io"]={write:function(){_lua_write_buffer+=Array.prototype.join.call(arguments,"");var e=_lua_write_buffer.split("\n");while(e.length>1){_lua_print(e.shift())}_lua_write_buffer=e[0];return[]},flush:function(){},stderr:null,stdin:null,stdout:null};_lua_io["close"]=_lua_io["input"]=_lua_io["lines"]=_lua_io["output"]=_lua_io["popen"]=_lua_io["read"]=_lua_io["tmpfile"]=_lua_io["type"]=_lua_io["open"]=function(){not_supported()};var _lua_randmax=4294967296;var _lua_randseed=Math.random()*_lua_randmax&_lua_randmax-1;lua_libs["math"]={abs:function(e){return[Math.abs(e)]},acos:function(e){return[Math.acos(e)]},asin:function(e){return[Math.asin(e)]},atan:function(e){return[Math.atan(e)]},atan2:function(e,t){return[Math.atan2(e,t)]},ceil:function(e){return[Math.ceil(e)]},cos:function(e){return[Math.cos(e)]},cosh:function(e){return[(Math.exp(e)+Math.exp(-e))/2]},deg:function(e){return[e*(180/Math.PI)]},exp:function(e){return[Math.exp(e)]},floor:function(e){return[Math.floor(e)]},fmod:function(e,t){return[e%t]},frexp:function(e,t){not_supported()},huge:Infinity,ldexp:function(e,t){return[e*Math.pow(2,t)]},log:function(e){return[Math.log(e)]},log10:function(e){return[Math.log(e)/Math.LN10]},max:function(){return[Math.max.apply(null,arguments)]},min:function(){return[Math.min.apply(null,arguments)]},modf:function(e){var t=e%1;return[e-t,t]},pi:Math.PI,pow:function(e,t){return[Math.pow(e,t)]},rad:function(e){return[e*(Math.PI/180)]},sin:function(e){return[Math.sin(e)]},sinh:function(e){return[(Math.exp(e)-Math.exp(-e))/2]},sqrt:function(e){return[Math.sqrt(e)]},tan:function(e){return[Math.tan(e)]},tanh:function(e){var t=Math.exp(e);var n=Math.exp(-e);return[(t-n)/(t+n)]},random:function(e,t){_lua_randseed=~_lua_randseed+(_lua_randseed<<15);_lua_randseed=_lua_randseed^_lua_randseed>>>12;_lua_randseed=_lua_randseed+(_lua_randseed<<2);_lua_randseed=_lua_randseed^_lua_randseed>>>4;_lua_randseed=_lua_randseed*2057;_lua_randseed=_lua_randseed^_lua_randseed>>>16;var n;if(_lua_randseed<0){n=(_lua_randseed+_lua_randmax)/_lua_randmax%1}else{n=_lua_randseed/_lua_randmax%1}if(arguments.length>=2){e=e|0;t=t|0;if(e>=t){throw new Error("Invalid range")}return[Math.floor(n*(t-e+1)+e)]}else if(arguments.length==1){e=e|0;return[Math.floor(n*e+1)]}else{return[n]}},randomseed:function(e){_lua_randseed=e&_lua_randmax-1}};var _lua_clock_start=(new Date).getTime()/1e3;lua_libs["os"]={clock:function(){return[(new Date).getTime()/1e3-_lua_clock_start]},date:function(e,t){return["["+t+"]"+e]},difftime:function(e,t){return[e-t]},execute:function(){return 0},exit:function(){not_supported()},getenv:function(e){return[null]},remove:function(){not_supported()},rename:function(){not_supported()},setlocale:function(){not_supported()},time:function(e){if(e){not_supported()}else{return[Math.floor((new Date).getTime()/1e3)]}}};var lua_packages=lua_newtable();lua_libs["package"]={path:"",cpath:"",loaded:lua_packages,loaders:lua_newtable(),preload:lua_newtable(),loadlib:function(){not_supported()}};lua_libs["string"]={"byte":function(e,t,n){e=check_string(e);t=lua_tonumber(t);n=lua_tonumber(n);if(t==null){t=1}if(n==null){n=t}t--;n--;var r=[];while(t>=0&&t<=n&&t<e.length){r.push(e.charCodeAt(t++))}return r},"char":function(){return[String.fromCharCode.apply(null,arguments)]},dump:function(e){not_supported()},find:function(e,t,n,r){e=check_string(e);n=lua_tonumber(n);if(n==null){n=1}else if(n<0){n=e.length+n}n--;e=e.substr(n);if(r==null||r===false){t=lua_pattern_to_regex(t);var i=get_balanced_match(e,t);if(i!==null){t=i}else{var s=e.match(t);if(s!==null){t=s[0]}else{return[null]}}}var o=e.indexOf(t);var u=[null];if(o!=-1){u=[o+n+1,o+n+t.length];if(s!=null&&s[1]!=null){u=u.concat(s.slice(1))}}return u},format:function(){function t(e){var t=typeof e;if(t=="object"&&Object.prototype.toString.call(e)=="[object Array]"){t="array"}return t}function n(e,t){for(var n=[];t>0;n[--t]=e){}return n.join("")}var e=function(){if(!e.cache.hasOwnProperty(arguments[0])){e.cache[arguments[0]]=e.parse(arguments[0])}return e.format.call(null,e.cache[arguments[0]],arguments)};e.cache={};e.format=function(e,r){var i=1;var s=e.length;var o="";var u;var a=[];var f;var l;var c;var h;var p;var d;for(f=0;f<s;f++){o=t(e[f]);if(o==="string"){a.push(e[f])}else if(o==="array"){c=e[f];if(c[2]){u=r[i];for(l=0;l<c[2].length;l++){if(!u.hasOwnProperty(c[2][l])){throw new Error('[string.format()] property "'+c[2][l]+'" does not exist')}u=u[c[2][l]]}}else if(c[1]){u=r[c[1]]}else{u=r[i++]}if(/[^sq]/.test(c[8])&&t(u)!="number"){throw new Error("[string.format()] expecting number but found "+t(u))}switch(c[8]){case"c":u=String.fromCharCode(u);break;case"i":case"d":u=parseInt(u,10);break;case"e":u=c[7]?u.toExponential(c[7]):u.toExponential(6);break;case"E":u=c[7]?u.toExponential(c[7]).toUpperCase():u.toExponential(6).toUpperCase();break;case"f":u=c[7]?parseFloat(u).toFixed(c[7]):parseFloat(u).toFixed(6);break;case"g":case"G":u=c[7]?parseFloat(u).toFixed(c[7]-1):parseFloat(u).toFixed(5);break;case"o":if(u<0){u=4294967295+u+1}u=u.toString(8);break;case"u":u=u>>>0;break;case"x":if(u<0){u=4294967295+u+1}u=u.toString(16);break;case"X":if(u<0){u=4294967295+u+1}u=u.toString(16).toUpperCase();break;case"q":u='"'+((u=String(u))&&c[7]?u.substring(0,c[7]):u)+'"';break;case"s":u=(u=String(u))&&c[7]?u.substring(0,c[7]):u;break;default:not_supported()}if(/[eE]/.test(c[8])){var v=/^(.+\+)(\d+)$/.exec(u);if(v!=null){if(v[2].length==1){u=v[1]+"00"+v[2]}else if(v[2].length==2){u=v[1]+"0"+v[2]}}}u=/[dieEf]/.test(c[8])&&c[3]&&u>=0?"+"+u:u;p=c[4]?c[4]=="0"?"0":c[4].charAt(1):" ";d=c[6]-String(u).length;h=c[6]?n(p,d):"";a.push(c[5]?u+h:h+u)}}return a.join("")};e.parse=function(e){var t=e;var n=[];var r=[];var i=0;while(t){if((n=/^[^\x25]+/.exec(t))!==null){r.push(n[0])}else if((n=/^\x25{2}/.exec(t))!==null){r.push("%")}else if((n=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([cdeEfgGiouxXqs])/.exec(t))!==null){if(n[2]){i|=1;var s=[];var o=n[2];var u=[];if((u=/^([a-z_][a-z_\d]*)/i.exec(o))!==null){s.push(u[1]);while((o=o.substring(u[0].length))!==""){if((u=/^\.([a-z_][a-z_\d]*)/i.exec(o))!==null){s.push(u[1])}else if((u=/^\[(\d+)\]/.exec(o))!==null){s.push(u[1])}else{throw new Error("[string.format()] No field_match found in replacement_field 1.")}}}else{throw new Error("[string.format()] No field_match found in replacement_field 2.")}n[2]=s}else{i|=2}if(i===3){throw new Error("[string.format()] mixing positional and named placeholders is not (yet) supported")}r.push(n)}else{throw new Error('[string.format()] Format string "'+e+'" not recognized.')}t=t.substring(n[0].length)}return r};if(arguments.length>0){arguments[0]=check_string(arguments[0])}return[e.apply(this,arguments)]},gmatch:function(e,t){var n=function(e){var t=get_balanced_match(e.s,e.pattern);if(t===null){var n=e.s.match(e.pattern);if(n===null){return[null]}else{if(n[1]!=null){t=n[1]}else{t=n[0]}}}e.s=e.s.substr(e.s.search(t)+t.length);return[t]};return[n,{s:check_string(e),pattern:lua_pattern_to_regex(t)}]},gsub:function(e,t,n,r){e=check_string(e);r=lua_tonumber(r);t=lua_pattern_to_regex(t);var i=new RegExp(t);var s=0;var o=typeof n;if(o=="string"){n=n.replace(/%([0-9]+)/g,"$$$1")}var u="";var a=function(a){var f=e.search(i)+a.length;var l=e.substr(0,f);var c="";if(o=="string"){c=l.replace(i,n)}else if(o=="function"){var h=null;var p=a.match(t);if(p[1]!=null){p=p.slice(1);h=n.apply(null,p)[0]}else{h=n(a)[0]}if(h==null){c=l}else{c=l.replace(i,h)}}u+=c;e=e.substr(f);s++;if(r!==null&&s>=r){return false}return true};var f=get_balanced_match(e,t);if(f!==null){var l=t[2];var c=t[3];var h=["[","]","(",")","{","}"];if(h.indexOf(l)!==-1){l="\\"+l}if(h.indexOf(c)!==-1){c="\\"+c}do{f=get_balanced_match(e,t);if(f===null){break}i=f.replace(new RegExp(l,"g"),l);i=i.replace(new RegExp(c,"g"),c);i=new RegExp(i)}while(a(f))}else{var p=e.match(new RegExp(t,"g"));for(var d in p){if(!a(p[d])){break}}}u+=e;return[u,s]},len:function(e){return[check_string(e).length]},lower:function(e){return[check_string(e).toLowerCase()]},match:function(e,t,n){e=check_string(e);n=lua_tonumber(n);if(n===null){n=1}else if(n<0){n=e.length+n}n--;e=e.substr(n);t=lua_pattern_to_regex(t);var r=get_balanced_match(e,t);if(r===null){var i=e.match(t);if(i!==null){if(i[1]!=null){r=i[1]}else{r=i[0]}}}return[r]},rep:function(e,t){e=check_string(e);t=lua_tonumber(t);if(t!==null){var n=[];while(t-->0){n.push(e)}return[n.join("")]}else{throw new Error("Input not string and number")}},reverse:function(e){return[check_string(e).split("").reverse().join("")]},sub:function(e,t,n){t=lua_tonumber(t);n=lua_tonumber(n);t=t<0?t+e.length+1:t>=0?t:0;if(n==null){n=-1}n=n<0?n+e.length+1:n>=0?n:0;if(t<1){t=1}if(n>e.length){n=e.length}if(t<=n){return[e.substr(t-1,n-t+1)]}else{return[""]}},upper:function(e){return[check_string(e).toUpperCase()]}};String.prototype["metatable"]=lua_newtable(null,"__index",lua_newtable2(lua_libs["string"]));lua_libs["table"]={concat:function(e,t,n,r){ensure_arraymode(e);if(t==null){t=""}if(n!=null){if(r==null){r=e.uints.length}return[e.uints.slice(n-1,r).join(t)]}else{return[e.uints.join(t)]}},insert:function(e,t,n){ensure_arraymode(e);if(arguments.length==2){n=t;t=e.uints.length+1}e.uints.splice(t-1,0,n);if(e.length!=null){e.length++}return[]},maxn:function(e){if(e.arraymode){return[e.uints.length]}else{var t=0;for(var n in e.uints){var r=parseFloat(n);if(r>t){t=r}}return[t]}},remove:function(e,t){ensure_arraymode(e);if(t==null){t=e.uints.length}else{t=lua_assertfloat(t)}if(e.uints.length){var n=e.uints[t-1];e.uints.splice(t-1,1);if(e.length!=null){e.length--}return[n]}else{return[]}},sort:function(e,t){ensure_arraymode(e);if(t){e.uints.sort(function(e,n){return t(e,n)[0]?-1:1})}else{e.uints.sort(function(e,t){return lua_lt(e,t)?-1:1})}return[]}};lua_libs["bit"]={tobit:function(e){return[e<<0]},tohex:function(e,t){if(t>0){var n=e.toString(16).substr(-t);while(n.length<t){n="0"+n}return[n]}else if(t<0){var n=e.toString(16).substr(t).toUpperCase();while(n.length<-t){n="0"+n}return[n]}else{return[e.toString(16)]}},bnot:function(e){return[~e]},bor:function(e){e=lua_assertfloat(e);for(var t=1;t<arguments.length;t++){e|=arguments[t]}return[e]},band:function(e){e=lua_assertfloat(e);for(var t=1;t<arguments.length;t++){e&=arguments[t]}return[e]},bxor:function(e){e=lua_assertfloat(e);for(var t=1;t<arguments.length;t++){e^=arguments[t]}return[e]},lshift:function(e,t){return[e<<t]},rshift:function(e,t){return[e>>>t]},arshift:function(e,t){return[e>>t]},rol:function(e,t){t&=15;return[e<<t|e>>>-t]},ror:function(e,t){t&=15;return[e>>>t|e<<-t]},bswap:function(e){e=e>>1&1431655765|(e&1431655765)<<1;e=e>>2&858993459|(e&858993459)<<2;e=e>>4&252645135|(e&252645135)<<4;e=e>>8&16711935|(e&16711935)<<8;e=e>>16|e<<16;return[e]}}